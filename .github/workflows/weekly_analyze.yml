name: Weekly Real Estate Analysis

on:
  schedule:
    # æ¯é€±æ—¥æ›œæ—¥ 22:00 UTC = æœˆæ›œæ—¥ 7:00 JST
    - cron: '0 22 * * 0'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download previous results
        continue-on-error: true
        run: |
          mkdir -p output cache
          # å‰å›ã®çµæœãŒã‚ã‚Œã°ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          if [ -f "output/analysis_results.json" ]; then
            echo "Previous results exist"
          fi

      - name: Restore cache
        uses: actions/cache@v4
        with:
          path: |
            cache/
            output/analysis_results.json
          key: analysis-cache-${{ github.run_number }}
          restore-keys: |
            analysis-cache-

      - name: Run analysis (10 companies)
        id: analysis
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          EDINET_API_KEY: ${{ secrets.EDINET_API_KEY }}
        run: |
          python weekly_runner.py --batch-size 10
          # å®Œäº†çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
          python -c "
          import json
          with open('output/analysis_results.json', 'r') as f:
              results = json.load(f)
          successful = [r for r in results if not r.get('error')]
          print(f'ANALYZED_COUNT={len(successful)}')
          print(f'IS_COMPLETE={'true' if len(successful) >= 500 else 'false'}')
          " >> $GITHUB_OUTPUT

      - name: Generate index page
        run: |
          python generate_index.py

      - name: Save cache
        uses: actions/cache/save@v4
        with:
          path: |
            cache/
            output/analysis_results.json
          key: analysis-cache-${{ github.run_number }}

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./output
          keep_files: true

      - name: Notify Chatwork (Progress)
        if: always()
        env:
          CHATWORK_API_TOKEN: ${{ secrets.CHATWORK_API_TOKEN }}
          CHATWORK_ROOM_ID: ${{ secrets.CHATWORK_ROOM_ID }}
        run: |
          # é€²æ—çŠ¶æ³ã‚’å–å¾—
          STATS=$(python -c "
          import json
          try:
              with open('output/analysis_results.json', 'r') as f:
                  results = json.load(f)
              successful = [r for r in results if not r.get('error')]
              total_gain = sum(r.get('total_unrealized_gain_million_yen', 0) or 0 for r in successful)
              print(f'{len(successful)}|{total_gain:.0f}')
          except:
              print('0|0')
          ")

          COUNT=$(echo $STATS | cut -d'|' -f1)
          GAIN=$(echo $STATS | cut -d'|' -f2)

          # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆ
          MESSAGE="[info][title]ğŸ¢ ä¸å‹•ç”£å«ã¿ç›Šè§£æ é€²æ—å ±å‘Š[/title]è§£æå®Œäº†: ${COUNT} / 500 ç¤¾
          å«ã¿ç›Šåˆè¨ˆ: Â¥${GAIN}m

          è©³ç´°: https://misonicomee-byte.github.io/real-estate-analyzer/[/info]"

          # Chatworkã«é€ä¿¡
          curl -X POST "https://api.chatwork.com/v2/rooms/${CHATWORK_ROOM_ID}/messages" \
            -H "X-ChatWorkToken: ${CHATWORK_API_TOKEN}" \
            -d "body=${MESSAGE}"

      - name: Notify Chatwork (Complete)
        if: steps.analysis.outputs.IS_COMPLETE == 'true'
        env:
          CHATWORK_API_TOKEN: ${{ secrets.CHATWORK_API_TOKEN }}
          CHATWORK_ROOM_ID: ${{ secrets.CHATWORK_ROOM_ID }}
        run: |
          # å®Œäº†æ™‚ã®è©³ç´°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
          STATS=$(python -c "
          import json
          with open('output/analysis_results.json', 'r') as f:
              results = json.load(f)
          successful = [r for r in results if not r.get('error') and r.get('total_unrealized_gain_million_yen')]
          successful.sort(key=lambda x: x.get('total_unrealized_gain_million_yen', 0) or 0, reverse=True)

          total_book = sum(r.get('total_book_value_million_yen', 0) or 0 for r in successful)
          total_gain = sum(r.get('total_unrealized_gain_million_yen', 0) or 0 for r in successful)

          top5 = '\\n'.join([f\"{i+1}. {r['company_name']}: +Â¥{r.get('total_unrealized_gain_million_yen', 0):,.0f}m\" for i, r in enumerate(successful[:5])])

          print(f'{len(successful)}|{total_book:.0f}|{total_gain:.0f}|{top5}')
          ")

          MESSAGE="[info][title]ğŸ‰ TOPIX500 ä¸å‹•ç”£å«ã¿ç›Šè§£æ å®Œäº†ï¼[/title]å…¨500ç¤¾ã®è§£æãŒå®Œäº†ã—ã¾ã—ãŸï¼

          ğŸ“Š é›†è¨ˆçµæœ
          ãƒ»ç°¿ä¾¡åˆè¨ˆ: Â¥$(echo $STATS | cut -d'|' -f2)m
          ãƒ»å«ã¿ç›Šåˆè¨ˆ: Â¥$(echo $STATS | cut -d'|' -f3)m

          ğŸ† å«ã¿ç›Šãƒˆãƒƒãƒ—5
          $(echo $STATS | cut -d'|' -f4)

          ğŸ“ è©³ç´°ãƒãƒƒãƒ—: https://misonicomee-byte.github.io/real-estate-analyzer/[/info]"

          curl -X POST "https://api.chatwork.com/v2/rooms/${CHATWORK_ROOM_ID}/messages" \
            -H "X-ChatWorkToken: ${CHATWORK_API_TOKEN}" \
            -d "body=${MESSAGE}"
